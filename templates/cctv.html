<!doctype html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <title>Document</title>
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=253bd596a29c6db40d6ec6054e201c83"></script>
    </head>
    <body>
        
        <button onclick="addCctv()">검색</button>
        <div id="map" style="width:100%;height:600px;"></div>

        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script type="text/javascript">
            let mapContainer = document.getElementById('map'), // 지도를 표시할 div  
            mapOption = { 
                center: new kakao.maps.LatLng(36.550701, 127.400000), // 지도의 중심좌표
                level: 9 // 지도의 확대 레벨
            };

            let map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

            let cctv=[];
            function addCctv(){
                // !!!!!url에 변수넣는거 해결해야됨!!!!
                // let apikey = "539decf6895149d4841444601842430f";
                // let type = "its";
                // let cctvType = 2;
                // let minX = '127.100000';
                // let maxX = '128.890000';
                // let minY = '34.100000';
                // let maxY = '39.100000';

                $.ajax({
                    type:'GET',
                    url:'https://openapi.its.go.kr:9443/cctvInfo?apiKey=539decf6895149d4841444601842430f&type=its&cctvType=2&minX=127.100000&maxX=127.790000&minY=36.100000&maxY=36.700000&getType=json',
                    success:function(response){
                        console.log(response)
                        len=response['response']['datacount']
                        for (let i=0;i<len;i++){
                            cctv.push({
                                name: response['response']["data"][i]["cctvname"],
                                url: response['response']["data"][i]["cctvurl"],
                                coordx: response['response']["data"][i]["coordx"],
                                coordy: response['response']["data"][i]["coordy"]
                            });
                        }
                
                        // 마커를 표시할 위치와 title 객체 배열입니다 
                        let positions=[]
                        console.log(cctv)
                        for (let i=0;i<len;i++){
                            positions.push({
                                title:cctv[i]["name"],
                                url: cctv[i]["url"],
                                latlng:new kakao.maps.LatLng(cctv[i]["coordy"],cctv[i]["coordx"])
                            });
                        }
                        

                        // 마커 이미지의 이미지 주소입니다
                        let imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"; 
                            
                        for (let i = 0; i < positions.length; i ++) {
                            
                            // 마커 이미지의 이미지 크기 입니다
                            let imageSize = new kakao.maps.Size(24, 35); 
                            
                            // 마커 이미지를 생성합니다    
                            let markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize); 
                            
                            // 마커를 생성합니다
                            let marker = new kakao.maps.Marker({
                                map: map, // 마커를 표시할 지도
                                position: positions[i].latlng, // 마커를 표시할 위치
                                title : positions[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
                                image : markerImage // 마커 이미지 
                            });
                            kakao.maps.event.addListener(marker,'click',function(){
                                window.open(cctv[i]["url"]);
                            })
                        }
                    },
                    error:function(error){
                        alert("Error!");
                    }
                })
            }
        </script>
    </body>
</html>